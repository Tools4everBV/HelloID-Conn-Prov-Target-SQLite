# Only needed for test purposes remove this when copy to target system
$person = '{"PersonId":"e94c6061-9fd2-4bd2-a938-29420bc0dbf9","PersonVersion":"v1","DisplayName":"Justin Konopelski (24866858)","ExternalId":"24866858","UserName":"Justin_Konopelski43","Location":{"ExternalId":null,"Code":null,"Name":null},"Details":{"Gender":"M","HonorificPrefix":null,"HonorificSuffix":null,"BirthDate":"2013-06-07T00:00:00Z","BirthLocality":"South Oletafurt","MaritalStatus":"Married"},"Name":{"Initials":"J.","GivenName":"Justin","NickName":"Justin","FamilyName":"Konopelski","FamilyNamePrefix":null,"FamilyNamePartner":"Schinner","FamilyNamePartnerPrefix":"van der","Convention":"B"},"Status":{"Blocked":false,"Reason":null},"Contact":{"Personal":{"Address":{"Street":"Price Bridge","StreetExt":null,"HouseNumber":"241","HouseNumberExt":null,"PostalCode":"42351-3631","Locality":"Gersonview","Country":"Ecuador"},"Phone":{"Mobile":"591-460-2396","Fixed":"(767) 479-0137 x1738"},"Email":"Justin.Konopelski64@yahoo.com"},"Business":{"Address":{"Street":null,"StreetExt":null,"HouseNumber":"0","HouseNumberExt":null,"PostalCode":null,"Locality":null,"Country":null},"Phone":{"Mobile":null,"Fixed":null},"Email":"J.Konopelski@alessandro.biz"}},"Contracts":[{"ExternalId":"C-24866858","StartDate":"2014-07-30T00:00:00Z","EndDate":"2026-12-18T00:00:00Z","Type":{"Code":null,"Description":null},"Details":{"Fte":0.0,"HoursPerWeek":38.0,"Percentage":0.0,"Sequence":0},"Location":{"ExternalId":null,"Code":null,"Name":null},"CostCenter":{"ExternalId":null,"Code":null,"Name":null},"CostBearer":{"ExternalId":null,"Code":null,"Name":null},"Employer":{"ExternalId":null,"Code":null,"Name":null},"Manager":{"PersonId":"00000000-0000-0000-0000-000000000000","ExternalId":null,"DisplayName":null,"Email":null},"Team":{"ExternalId":null,"Code":null,"Name":null},"Department":{"ExternalId":"cdw1qyvavn","DisplayName":"Jewelery, Beauty & Movies"},"Division":{"ExternalId":null,"Code":null,"Name":null},"Title":{"ExternalId":null,"Code":null,"Name":"Dynamic Division Director"},"Organization":{"ExternalId":null,"Code":null,"Name":null}},{"ExternalId":"C-10126645","StartDate":"2018-12-17T00:00:00Z","EndDate":"2021-09-23T00:00:00Z","Type":{"Code":null,"Description":null},"Details":{"Fte":0.0,"HoursPerWeek":26.0,"Percentage":0.0,"Sequence":0},"Location":{"ExternalId":null,"Code":null,"Name":null},"CostCenter":{"ExternalId":null,"Code":null,"Name":null},"CostBearer":{"ExternalId":null,"Code":null,"Name":null},"Employer":{"ExternalId":null,"Code":null,"Name":null},"Manager":{"PersonId":"00000000-0000-0000-0000-000000000000","ExternalId":null,"DisplayName":null,"Email":null},"Team":{"ExternalId":null,"Code":null,"Name":null},"Department":{"ExternalId":"9yumg1jr8r","DisplayName":"Health, Music & Beauty"},"Division":{"ExternalId":null,"Code":null,"Name":null},"Title":{"ExternalId":null,"Code":null,"Name":"National Metrics Developer"},"Organization":{"ExternalId":null,"Code":null,"Name":null}},{"ExternalId":"C-28272922","StartDate":"2012-03-16T00:00:00Z","EndDate":"2026-04-07T00:00:00Z","Type":{"Code":null,"Description":null},"Details":{"Fte":0.0,"HoursPerWeek":15.0,"Percentage":0.0,"Sequence":0},"Location":{"ExternalId":null,"Code":null,"Name":null},"CostCenter":{"ExternalId":null,"Code":null,"Name":null},"CostBearer":{"ExternalId":null,"Code":null,"Name":null},"Employer":{"ExternalId":null,"Code":null,"Name":null},"Manager":{"PersonId":"00000000-0000-0000-0000-000000000000","ExternalId":null,"DisplayName":null,"Email":null},"Team":{"ExternalId":null,"Code":null,"Name":null},"Department":{"ExternalId":"mrxxo03509","DisplayName":"Tools, Outdoors & Movies"},"Division":{"ExternalId":null,"Code":null,"Name":null},"Title":{"ExternalId":null,"Code":null,"Name":"Chief Security Officer"},"Organization":{"ExternalId":null,"Code":null,"Name":null}},{"ExternalId":"C-79794769","StartDate":"2011-04-24T00:00:00Z","EndDate":"2022-04-27T00:00:00Z","Type":{"Code":null,"Description":null},"Details":{"Fte":0.0,"HoursPerWeek":29.0,"Percentage":0.0,"Sequence":0},"Location":{"ExternalId":null,"Code":null,"Name":null},"CostCenter":{"ExternalId":null,"Code":null,"Name":null},"CostBearer":{"ExternalId":null,"Code":null,"Name":null},"Employer":{"ExternalId":null,"Code":null,"Name":null},"Manager":{"PersonId":"00000000-0000-0000-0000-000000000000","ExternalId":null,"DisplayName":null,"Email":null},"Team":{"ExternalId":null,"Code":null,"Name":null},"Department":{"ExternalId":"p504w51ohe","DisplayName":"Games, Baby & Automotive"},"Division":{"ExternalId":null,"Code":null,"Name":null},"Title":{"ExternalId":null,"Code":null,"Name":"Internal Accountability Designer"},"Organization":{"ExternalId":null,"Code":null,"Name":null}},{"ExternalId":"C-69929583","StartDate":"2009-04-30T00:00:00Z","EndDate":"2027-04-24T00:00:00Z","Type":{"Code":null,"Description":null},"Details":{"Fte":0.0,"HoursPerWeek":21.0,"Percentage":0.0,"Sequence":0},"Location":{"ExternalId":null,"Code":null,"Name":null},"CostCenter":{"ExternalId":null,"Code":null,"Name":null},"CostBearer":{"ExternalId":null,"Code":null,"Name":null},"Employer":{"ExternalId":null,"Code":null,"Name":null},"Manager":{"PersonId":"00000000-0000-0000-0000-000000000000","ExternalId":null,"DisplayName":null,"Email":null},"Team":{"ExternalId":null,"Code":null,"Name":null},"Department":{"ExternalId":"ppy35ds6sb","DisplayName":"Home & Kids"},"Division":{"ExternalId":null,"Code":null,"Name":null},"Title":{"ExternalId":null,"Code":null,"Name":"Internal Brand Analyst"},"Organization":{"ExternalId":null,"Code":null,"Name":null}}],"PrimaryContract":{"ExternalId":"C-24866858","StartDate":"2014-07-30T00:00:00Z","EndDate":"2026-12-18T00:00:00Z","Type":{"Code":null,"Description":null},"Details":{"Fte":0.0,"HoursPerWeek":38.0,"Percentage":0.0,"Sequence":0},"Location":{"ExternalId":null,"Code":null,"Name":null},"CostCenter":{"ExternalId":null,"Code":null,"Name":null},"CostBearer":{"ExternalId":null,"Code":null,"Name":null},"Employer":{"ExternalId":null,"Code":null,"Name":null},"Manager":{"PersonId":"00000000-0000-0000-0000-000000000000","ExternalId":null,"DisplayName":null,"Email":null},"Team":{"ExternalId":null,"Code":null,"Name":null},"Department":{"ExternalId":"cdw1qyvavn","DisplayName":"Jewelery, Beauty & Movies"},"Division":{"ExternalId":null,"Code":null,"Name":null},"Title":{"ExternalId":null,"Code":null,"Name":"Dynamic Division Director"},"Organization":{"ExternalId":null,"Code":null,"Name":null}},"PrimaryManager":{"PersonId":"00000000-0000-0000-0000-000000000000","ExternalId":null,"DisplayName":null,"Email":null}}'

Add-Type -Path "C:\Program Files (x86)\System.Data.SQLite\2015\bin\System.Data.SQLite.dll";
$db = "C:\Temp\HelloID_Target.db";

#Initialize default properties
$p = $person | ConvertFrom-Json;
$accountReference = $accountReference | ConvertFrom-Json;
$success = $False;
$auditMessage = "Account for person " + $p.DisplayName + " not enabled succesfully";

#Change mapping here
$account = [PSCustomObject]@{
    enabled = $True;
}

Try {
    If (Test-Path $db) {
		if(-Not($dryRun -eq $True)){  
			$conn = New-Object -TypeName System.Data.SQLite.SQLiteConnection
			$conn.ConnectionString = "Data Source=$db"
			$conn.Open()
			$cmd = $conn.CreateCommand()
	
			$sql = "UPDATE users SET enabled = '" + $account.enabled + "'"
			$sql += " WHERE externalId = '$accountReference';"
			
			$cmd.CommandText = $sql
			$cmd.ExecuteNonQuery() | Out-Null
			$cmd.Dispose()
			$conn.Close()
		}
        $success = $True;
        $auditMessage = " succesfully";
    }
} catch{
        $ex = $_.Exception
		$auditMessage = " not enabled succesfully: General error";
}

#build up result
$result = [PSCustomObject]@{ 
	Success= $success;
	AccountReference= $accountReference;
	AuditDetails=$auditMessage;
	Account = $account;
	
	# Optionally return data for use in other systems
    ExportData = [PSCustomObject]@{
        displayName = $account.DisplayName;
        userName = $account.UserName;
		externalId = $accountReference;
		enabled = $account.enabled;
    };
};
Write-Output $result | ConvertTo-Json -Depth 10;